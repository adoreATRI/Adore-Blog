---
import {Icon} from "astro-icon/components";
---

<!-- There can't be a filter on parent element, or it will break `fixed` -->
<div class="back-to-top-wrapper block">
    <!-- 圆形返回顶部按钮，带进度条 -->
    <div id="back-to-top-btn" class="back-to-top-btn hide transition"
         onclick="backToTop()">
        <svg class="progress-ring" width="50" height="50">
            <circle class="progress-ring-bg" cx="25" cy="25" r="22" />
            <circle class="progress-ring-progress" cx="25" cy="25" r="22" id="progress-circle" />
        </svg>
        <button aria-label="Back to Top" class="btn-circle">
            <Icon name="material-symbols:keyboard-arrow-up-rounded" class="icon-arrow"></Icon>
        </button>
    </div>
    
    <!-- 文章滚动条 - 紧贴右边缘 -->
    <div id="article-scrollbar" class="article-scrollbar hide">
        <div class="scrollbar-track">
            <div id="scrollbar-thumb" class="scrollbar-thumb"></div>
        </div>
    </div>
</div>

<style lang="stylus">
  .back-to-top-wrapper
    position: fixed
    right: 0
    top: 0
    pointer-events: none
    z-index: 100

  /* 圆形返回顶部按钮 */
  .back-to-top-btn
    position: fixed
    bottom: 2rem
    right: 2rem
    width: 50px
    height: 50px
    cursor: pointer
    pointer-events: auto
    opacity: 0
    transform: scale(0.8)
    transition: all 0.3s ease

    &:not(.hide)
      opacity: 1
      transform: scale(1)

    &:active
      transform: scale(0.9)

  /* SVG 进度环 */
  .progress-ring
    position: absolute
    top: 0
    left: 0
    transform: rotate(-90deg)
    width: 50px
    height: 50px
    
  .progress-ring-bg
    fill: none
    stroke: rgba(128, 128, 128, 0.2)
    stroke-width: 2
    
  .progress-ring-progress
    fill: none
    stroke: var(--primary)
    stroke-width: 2
    stroke-dasharray: 138.23
    stroke-dashoffset: 138.23
    transition: stroke-dashoffset 0.3s ease
    stroke-linecap: round

  /* 圆形按钮 */
  .btn-circle
    position: absolute
    top: 50%
    left: 50%
    transform: translate(-50%, -50%)
    width: 40px
    height: 40px
    border-radius: 50%
    background: var(--card-bg)
    border: none
    display: flex
    align-items: center
    justify-content: center
    cursor: pointer
    transition: all 0.2s ease
    color: var(--primary)
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15)
    
    &:hover
      background: var(--btn-card-bg-hover)
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2)
      
    &:active
      transform: translate(-50%, -50%) scale(0.95)

  .icon-arrow
    font-size: 1.5rem

  /* 文章滚动条 - 紧贴浏览器右边缘 */
  .article-scrollbar
    position: fixed
    right: 0
    top: 50%
    transform: translateY(-50%)
    width: 12px
    height: 40vh
    min-height: 200px
    max-height: 400px
    pointer-events: auto
    opacity: 0
    transition: all 0.3s ease
    padding: 4px
    z-index: 99
    
    &:not(.hide)
      opacity: 1
  
  .scrollbar-track
    width: 4px
    height: 100%
    background: rgba(128, 128, 128, 0.2)
    border-radius: 2px
    position: relative
    cursor: pointer
    
  .scrollbar-thumb
    width: 4px
    background: var(--primary)
    border-radius: 2px
    position: absolute
    top: 0
    left: 0
    min-height: 30px
    cursor: grab
    transition: all 0.2s ease
    
    &:hover
      width: 6px
      background: var(--primary)
      opacity: 0.9
      margin-left: -1px
      
    &:active
      cursor: grabbing
      width: 6px
      margin-left: -1px

  // 手机端隐藏
  @media (max-width: 768px)
    .back-to-top-wrapper
      display: none

</style>

<script is:raw is:inline>
    function backToTop() {
        window.scroll({top: 0, behavior: 'smooth'});
    }
    
    // 初始化进度条和滚动条
    function initScrollFeatures() {
        const backToTopBtn = document.getElementById('back-to-top-btn');
        const progressCircle = document.getElementById('progress-circle');
        const articleScrollbar = document.getElementById('article-scrollbar');
        const scrollbarThumb = document.getElementById('scrollbar-thumb');
        const scrollbarTrack = articleScrollbar?.querySelector('.scrollbar-track');
        
        if (!backToTopBtn || !progressCircle || !articleScrollbar || !scrollbarThumb || !scrollbarTrack) {
            return;
        }
        
        const radius = 22;
        const circumference = 2 * Math.PI * radius;
        
        let isDragging = false;
        
        function updateScrollIndicators() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrollPercentage = (scrollTop / docHeight) * 100;
            
            // 更新环形进度条
            const offset = circumference - (scrollPercentage / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            
            // 获取滚动条实际高度
            const scrollbarHeight = scrollbarTrack.clientHeight;
            
            // 更新滚动条滑块位置和高度
            const viewportHeight = document.documentElement.clientHeight;
            const totalHeight = document.documentElement.scrollHeight;
            const thumbHeightRatio = viewportHeight / totalHeight;
            const thumbHeight = Math.max(30, scrollbarHeight * thumbHeightRatio);
            scrollbarThumb.style.height = thumbHeight + 'px';
            
            const maxThumbTop = scrollbarHeight - thumbHeight;
            const thumbTop = (scrollPercentage / 100) * maxThumbTop;
            scrollbarThumb.style.top = thumbTop + 'px';
            
            // 显示/隐藏按钮和滚动条
            if (scrollTop > 100) {
                backToTopBtn.classList.remove('hide');
                articleScrollbar.classList.remove('hide');
            } else {
                backToTopBtn.classList.add('hide');
                articleScrollbar.classList.add('hide');
            }
        }
        
        // 滚动条拖拽功能
        scrollbarThumb.addEventListener('mousedown', (e) => {
            isDragging = true;
            e.preventDefault();
        });
        
        // 点击轨道跳转
        scrollbarTrack.addEventListener('click', (e) => {
            if (e.target === scrollbarThumb) return;
            
            const rect = scrollbarTrack.getBoundingClientRect();
            const clickY = e.clientY - rect.top;
            const scrollbarHeight = scrollbarTrack.clientHeight;
            const percentage = clickY / scrollbarHeight;
            const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const targetScroll = percentage * docHeight;
            
            window.scroll({top: targetScroll, behavior: 'smooth'});
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const rect = scrollbarTrack.getBoundingClientRect();
            const scrollbarHeight = scrollbarTrack.clientHeight;
            const mouseY = e.clientY - rect.top;
            const percentage = Math.max(0, Math.min(1, mouseY / scrollbarHeight));
            const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const targetScroll = percentage * docHeight;
            
            window.scroll({top: targetScroll, behavior: 'auto'});
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
            }
        });
        
        // 监听滚动事件
        window.addEventListener('scroll', updateScrollIndicators, { passive: true });
        
        // 监听窗口大小变化
        window.addEventListener('resize', updateScrollIndicators, { passive: true });
        
        // 初始化
        updateScrollIndicators();
    }
    
    // 页面加载时初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initScrollFeatures);
    } else {
        initScrollFeatures();
    }
    
    // Swup 页面切换时重新初始化
    document.addEventListener('swup:page:view', initScrollFeatures);
</script>
